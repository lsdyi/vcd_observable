var ee,ct=Object.create,_e=Object.defineProperty,dt=Object.getOwnPropertyDescriptor,pt=Object.getOwnPropertyNames,ft=Object.getPrototypeOf,yt=Object.prototype.hasOwnProperty,S=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),wt=(e,t,r,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of pt(t))!yt.call(e,a)&&a!==r&&_e(e,a,{get:()=>t[a],enumerable:!(s=dt(t,a))||s.enumerable});return e},mt=(e,t,r)=>(r=e!=null?ct(ft(e)):{},wt(!e||!e.__esModule?_e(r,"default",{value:e,enumerable:!0}):r,e)),te=S(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.getUint64=e.getInt64=e.setInt64=e.setUint64=e.UINT32_MAX=void 0,e.UINT32_MAX=4294967295;function t(i,n,o){let u=o/4294967296,p=o;i.setUint32(n,u),i.setUint32(n+4,p)}e.setUint64=t;function r(i,n,o){let u=Math.floor(o/4294967296),p=o;i.setUint32(n,u),i.setUint32(n+4,p)}e.setInt64=r;function s(i,n){let o=i.getInt32(n),u=i.getUint32(n+4);return o*4294967296+u}e.getInt64=s;function a(i,n){let o=i.getUint32(n),u=i.getUint32(n+4);return o*4294967296+u}e.getUint64=a}),le=S(e=>{var t,r,s;Object.defineProperty(e,"__esModule",{value:!0}),e.utf8DecodeTD=e.TEXT_DECODER_THRESHOLD=e.utf8DecodeJs=e.utf8EncodeTE=e.TEXT_ENCODER_THRESHOLD=e.utf8EncodeJs=e.utf8Count=void 0;var a=te(),i=(typeof process>"u"||((t=process==null?void 0:process.env)===null||t===void 0?void 0:t.TEXT_ENCODING)!=="never")&&typeof TextEncoder<"u"&&typeof TextDecoder<"u";function n(l){let c=l.length,y=0,d=0;for(;d<c;){let m=l.charCodeAt(d++);if(m&4294967168)if(!(m&4294965248))y+=2;else{if(m>=55296&&m<=56319&&d<c){let b=l.charCodeAt(d);(b&64512)===56320&&(++d,m=((m&1023)<<10)+(b&1023)+65536)}m&4294901760?y+=4:y+=3}else{y++;continue}}return y}e.utf8Count=n;function o(l,c,y){let d=l.length,m=y,b=0;for(;b<d;){let E=l.charCodeAt(b++);if(E&4294967168)if(!(E&4294965248))c[m++]=E>>6&31|192;else{if(E>=55296&&E<=56319&&b<d){let U=l.charCodeAt(b);(U&64512)===56320&&(++b,E=((E&1023)<<10)+(U&1023)+65536)}E&4294901760?(c[m++]=E>>18&7|240,c[m++]=E>>12&63|128,c[m++]=E>>6&63|128):(c[m++]=E>>12&15|224,c[m++]=E>>6&63|128)}else{c[m++]=E;continue}c[m++]=E&63|128}}e.utf8EncodeJs=o;var u=i?new TextEncoder:void 0;e.TEXT_ENCODER_THRESHOLD=i?typeof process<"u"&&((r=process==null?void 0:process.env)===null||r===void 0?void 0:r.TEXT_ENCODING)!=="force"?200:0:a.UINT32_MAX;function p(l,c,y){c.set(u.encode(l),y)}function f(l,c,y){u.encodeInto(l,c.subarray(y))}e.utf8EncodeTE=u?.encodeInto?f:p;var w=4096;function v(l,c,y){let d=c,m=d+y,b=[],E="";for(;d<m;){let U=l[d++];if(!(U&128))b.push(U);else if((U&224)===192){let Q=l[d++]&63;b.push((U&31)<<6|Q)}else if((U&240)===224){let Q=l[d++]&63,oe=l[d++]&63;b.push((U&31)<<12|Q<<6|oe)}else if((U&248)===240){let Q=l[d++]&63,oe=l[d++]&63,ht=l[d++]&63,z=(U&7)<<18|Q<<12|oe<<6|ht;z>65535&&(z-=65536,b.push(z>>>10&1023|55296),z=56320|z&1023),b.push(z)}else b.push(U);b.length>=w&&(E+=String.fromCharCode(...b),b.length=0)}return b.length>0&&(E+=String.fromCharCode(...b)),E}e.utf8DecodeJs=v;var A=i?new TextDecoder:null;e.TEXT_DECODER_THRESHOLD=i?typeof process<"u"&&((s=process==null?void 0:process.env)===null||s===void 0?void 0:s.TEXT_DECODER)!=="force"?200:0:a.UINT32_MAX;function k(l,c,y){let d=l.subarray(c,c+y);return A.decode(d)}e.utf8DecodeTD=k}),Se=S(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.ExtData=void 0;var t=class{constructor(r,s){this.type=r,this.data=s}};e.ExtData=t}),ue=S(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.DecodeError=void 0;var t=class Te extends Error{constructor(s){super(s);let a=Object.create(Te.prototype);Object.setPrototypeOf(this,a),Object.defineProperty(this,"name",{configurable:!0,enumerable:!1,value:Te.name})}};e.DecodeError=t}),xe=S(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.timestampExtension=e.decodeTimestampExtension=e.decodeTimestampToTimeSpec=e.encodeTimestampExtension=e.encodeDateToTimeSpec=e.encodeTimeSpecToTimestamp=e.EXT_TIMESTAMP=void 0;var t=ue(),r=te();e.EXT_TIMESTAMP=-1;var s=4294967296-1,a=17179869184-1;function i({sec:f,nsec:w}){if(f>=0&&w>=0&&f<=a)if(w===0&&f<=s){let v=new Uint8Array(4);return new DataView(v.buffer).setUint32(0,f),v}else{let v=f/4294967296,A=f&4294967295,k=new Uint8Array(8),l=new DataView(k.buffer);return l.setUint32(0,w<<2|v&3),l.setUint32(4,A),k}else{let v=new Uint8Array(12),A=new DataView(v.buffer);return A.setUint32(0,w),(0,r.setInt64)(A,4,f),v}}e.encodeTimeSpecToTimestamp=i;function n(f){let w=f.getTime(),v=Math.floor(w/1e3),A=(w-v*1e3)*1e6,k=Math.floor(A/1e9);return{sec:v+k,nsec:A-k*1e9}}e.encodeDateToTimeSpec=n;function o(f){if(f instanceof Date){let w=n(f);return i(w)}else return null}e.encodeTimestampExtension=o;function u(f){let w=new DataView(f.buffer,f.byteOffset,f.byteLength);switch(f.byteLength){case 4:return{sec:w.getUint32(0),nsec:0};case 8:{let v=w.getUint32(0),A=w.getUint32(4),k=(v&3)*4294967296+A,l=v>>>2;return{sec:k,nsec:l}}case 12:{let v=(0,r.getInt64)(w,4),A=w.getUint32(0);return{sec:v,nsec:A}}default:throw new t.DecodeError(`Unrecognized data size for timestamp (expected 4, 8, or 12): ${f.length}`)}}e.decodeTimestampToTimeSpec=u;function p(f){let w=u(f);return new Date(w.sec*1e3+w.nsec/1e6)}e.decodeTimestampExtension=p,e.timestampExtension={type:e.EXT_TIMESTAMP,encode:o,decode:p}}),he=S(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.ExtensionCodec=void 0;var t=Se(),r=xe(),s=class{constructor(){this.builtInEncoders=[],this.builtInDecoders=[],this.encoders=[],this.decoders=[],this.register(r.timestampExtension)}register({type:a,encode:i,decode:n}){if(a>=0)this.encoders[a]=i,this.decoders[a]=n;else{let o=1+a;this.builtInEncoders[o]=i,this.builtInDecoders[o]=n}}tryToEncode(a,i){for(let n=0;n<this.builtInEncoders.length;n++){let o=this.builtInEncoders[n];if(o!=null){let u=o(a,i);if(u!=null){let p=-1-n;return new t.ExtData(p,u)}}}for(let n=0;n<this.encoders.length;n++){let o=this.encoders[n];if(o!=null){let u=o(a,i);if(u!=null){let p=n;return new t.ExtData(p,u)}}}return a instanceof t.ExtData?a:null}decode(a,i,n){let o=i<0?this.builtInDecoders[-1-i]:this.decoders[i];return o?o(a,i,n):new t.ExtData(i,a)}};e.ExtensionCodec=s,s.defaultCodec=new s}),Ae=S(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.createDataView=e.ensureUint8Array=void 0;function t(s){return s instanceof Uint8Array?s:ArrayBuffer.isView(s)?new Uint8Array(s.buffer,s.byteOffset,s.byteLength):s instanceof ArrayBuffer?new Uint8Array(s):Uint8Array.from(s)}e.ensureUint8Array=t;function r(s){if(s instanceof ArrayBuffer)return new DataView(s);let a=t(s);return new DataView(a.buffer,a.byteOffset,a.byteLength)}e.createDataView=r}),Ue=S(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Encoder=e.DEFAULT_INITIAL_BUFFER_SIZE=e.DEFAULT_MAX_DEPTH=void 0;var t=le(),r=he(),s=te(),a=Ae();e.DEFAULT_MAX_DEPTH=100,e.DEFAULT_INITIAL_BUFFER_SIZE=2048;var i=class{constructor(n=r.ExtensionCodec.defaultCodec,o=void 0,u=e.DEFAULT_MAX_DEPTH,p=e.DEFAULT_INITIAL_BUFFER_SIZE,f=!1,w=!1,v=!1,A=!1){this.extensionCodec=n,this.context=o,this.maxDepth=u,this.initialBufferSize=p,this.sortKeys=f,this.forceFloat32=w,this.ignoreUndefined=v,this.forceIntegerToFloat=A,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}reinitializeState(){this.pos=0}encodeSharedRef(n){return this.reinitializeState(),this.doEncode(n,1),this.bytes.subarray(0,this.pos)}encode(n){return this.reinitializeState(),this.doEncode(n,1),this.bytes.slice(0,this.pos)}doEncode(n,o){if(o>this.maxDepth)throw new Error(`Too deep objects in depth ${o}`);n==null?this.encodeNil():typeof n=="boolean"?this.encodeBoolean(n):typeof n=="number"?this.encodeNumber(n):typeof n=="string"?this.encodeString(n):this.encodeObject(n,o)}ensureBufferSizeToWrite(n){let o=this.pos+n;this.view.byteLength<o&&this.resizeBuffer(o*2)}resizeBuffer(n){let o=new ArrayBuffer(n),u=new Uint8Array(o),p=new DataView(o);u.set(this.bytes),this.view=p,this.bytes=u}encodeNil(){this.writeU8(192)}encodeBoolean(n){n===!1?this.writeU8(194):this.writeU8(195)}encodeNumber(n){Number.isSafeInteger(n)&&!this.forceIntegerToFloat?n>=0?n<128?this.writeU8(n):n<256?(this.writeU8(204),this.writeU8(n)):n<65536?(this.writeU8(205),this.writeU16(n)):n<4294967296?(this.writeU8(206),this.writeU32(n)):(this.writeU8(207),this.writeU64(n)):n>=-32?this.writeU8(224|n+32):n>=-128?(this.writeU8(208),this.writeI8(n)):n>=-32768?(this.writeU8(209),this.writeI16(n)):n>=-2147483648?(this.writeU8(210),this.writeI32(n)):(this.writeU8(211),this.writeI64(n)):this.forceFloat32?(this.writeU8(202),this.writeF32(n)):(this.writeU8(203),this.writeF64(n))}writeStringHeader(n){if(n<32)this.writeU8(160+n);else if(n<256)this.writeU8(217),this.writeU8(n);else if(n<65536)this.writeU8(218),this.writeU16(n);else if(n<4294967296)this.writeU8(219),this.writeU32(n);else throw new Error(`Too long string: ${n} bytes in UTF-8`)}encodeString(n){if(n.length>t.TEXT_ENCODER_THRESHOLD){let o=(0,t.utf8Count)(n);this.ensureBufferSizeToWrite(5+o),this.writeStringHeader(o),(0,t.utf8EncodeTE)(n,this.bytes,this.pos),this.pos+=o}else{let o=(0,t.utf8Count)(n);this.ensureBufferSizeToWrite(5+o),this.writeStringHeader(o),(0,t.utf8EncodeJs)(n,this.bytes,this.pos),this.pos+=o}}encodeObject(n,o){let u=this.extensionCodec.tryToEncode(n,this.context);if(u!=null)this.encodeExtension(u);else if(Array.isArray(n))this.encodeArray(n,o);else if(ArrayBuffer.isView(n))this.encodeBinary(n);else if(typeof n=="object")this.encodeMap(n,o);else throw new Error(`Unrecognized object: ${Object.prototype.toString.apply(n)}`)}encodeBinary(n){let o=n.byteLength;if(o<256)this.writeU8(196),this.writeU8(o);else if(o<65536)this.writeU8(197),this.writeU16(o);else if(o<4294967296)this.writeU8(198),this.writeU32(o);else throw new Error(`Too large binary: ${o}`);let u=(0,a.ensureUint8Array)(n);this.writeU8a(u)}encodeArray(n,o){let u=n.length;if(u<16)this.writeU8(144+u);else if(u<65536)this.writeU8(220),this.writeU16(u);else if(u<4294967296)this.writeU8(221),this.writeU32(u);else throw new Error(`Too large array: ${u}`);for(let p of n)this.doEncode(p,o+1)}countWithoutUndefined(n,o){let u=0;for(let p of o)n[p]!==void 0&&u++;return u}encodeMap(n,o){let u=Object.keys(n);this.sortKeys&&u.sort();let p=this.ignoreUndefined?this.countWithoutUndefined(n,u):u.length;if(p<16)this.writeU8(128+p);else if(p<65536)this.writeU8(222),this.writeU16(p);else if(p<4294967296)this.writeU8(223),this.writeU32(p);else throw new Error(`Too large map object: ${p}`);for(let f of u){let w=n[f];this.ignoreUndefined&&w===void 0||(this.encodeString(f),this.doEncode(w,o+1))}}encodeExtension(n){let o=n.data.length;if(o===1)this.writeU8(212);else if(o===2)this.writeU8(213);else if(o===4)this.writeU8(214);else if(o===8)this.writeU8(215);else if(o===16)this.writeU8(216);else if(o<256)this.writeU8(199),this.writeU8(o);else if(o<65536)this.writeU8(200),this.writeU16(o);else if(o<4294967296)this.writeU8(201),this.writeU32(o);else throw new Error(`Too large extension object: ${o}`);this.writeI8(n.type),this.writeU8a(n.data)}writeU8(n){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,n),this.pos++}writeU8a(n){let o=n.length;this.ensureBufferSizeToWrite(o),this.bytes.set(n,this.pos),this.pos+=o}writeI8(n){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,n),this.pos++}writeU16(n){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,n),this.pos+=2}writeI16(n){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,n),this.pos+=2}writeU32(n){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,n),this.pos+=4}writeI32(n){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,n),this.pos+=4}writeF32(n){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,n),this.pos+=4}writeF64(n){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,n),this.pos+=8}writeU64(n){this.ensureBufferSizeToWrite(8),(0,s.setUint64)(this.view,this.pos,n),this.pos+=8}writeI64(n){this.ensureBufferSizeToWrite(8),(0,s.setInt64)(this.view,this.pos,n),this.pos+=8}};e.Encoder=i}),gt=S(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.encode=void 0;var t=Ue(),r={};function s(a,i=r){return new t.Encoder(i.extensionCodec,i.context,i.maxDepth,i.initialBufferSize,i.sortKeys,i.forceFloat32,i.ignoreUndefined,i.forceIntegerToFloat).encodeSharedRef(a)}e.encode=s}),bt=S(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.prettyByte=void 0;function t(r){return`${r<0?"-":""}0x${Math.abs(r).toString(16).padStart(2,"0")}`}e.prettyByte=t}),vt=S(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.CachedKeyDecoder=void 0;var t=le(),r=16,s=16,a=class{constructor(i=r,n=s){this.maxKeyLength=i,this.maxLengthPerKey=n,this.hit=0,this.miss=0,this.caches=[];for(let o=0;o<this.maxKeyLength;o++)this.caches.push([])}canBeCached(i){return i>0&&i<=this.maxKeyLength}find(i,n,o){let u=this.caches[o-1];e:for(let p of u){let f=p.bytes;for(let w=0;w<o;w++)if(f[w]!==i[n+w])continue e;return p.str}return null}store(i,n){let o=this.caches[i.length-1],u={bytes:i,str:n};o.length>=this.maxLengthPerKey?o[Math.random()*o.length|0]=u:o.push(u)}decode(i,n,o){let u=this.find(i,n,o);if(u!=null)return this.hit++,u;this.miss++;let p=(0,t.utf8DecodeJs)(i,n,o),f=Uint8Array.prototype.slice.call(i,n,n+o);return this.store(f,p),p}};e.CachedKeyDecoder=a}),ce=S(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Decoder=e.DataViewIndexOutOfBoundsError=void 0;var t=bt(),r=he(),s=te(),a=le(),i=Ae(),n=vt(),o=ue(),u=l=>{let c=typeof l;return c==="string"||c==="number"},p=-1,f=new DataView(new ArrayBuffer(0)),w=new Uint8Array(f.buffer);e.DataViewIndexOutOfBoundsError=(()=>{try{f.getInt8(0)}catch(l){return l.constructor}throw new Error("never reached")})();var v=new e.DataViewIndexOutOfBoundsError("Insufficient data"),A=new n.CachedKeyDecoder,k=class{constructor(l=r.ExtensionCodec.defaultCodec,c=void 0,y=s.UINT32_MAX,d=s.UINT32_MAX,m=s.UINT32_MAX,b=s.UINT32_MAX,E=s.UINT32_MAX,U=A){this.extensionCodec=l,this.context=c,this.maxStrLength=y,this.maxBinLength=d,this.maxArrayLength=m,this.maxMapLength=b,this.maxExtLength=E,this.keyDecoder=U,this.totalPos=0,this.pos=0,this.view=f,this.bytes=w,this.headByte=p,this.stack=[]}reinitializeState(){this.totalPos=0,this.headByte=p,this.stack.length=0}setBuffer(l){this.bytes=(0,i.ensureUint8Array)(l),this.view=(0,i.createDataView)(this.bytes),this.pos=0}appendBuffer(l){if(this.headByte===p&&!this.hasRemaining(1))this.setBuffer(l);else{let c=this.bytes.subarray(this.pos),y=(0,i.ensureUint8Array)(l),d=new Uint8Array(c.length+y.length);d.set(c),d.set(y,c.length),this.setBuffer(d)}}hasRemaining(l){return this.view.byteLength-this.pos>=l}createExtraByteError(l){let{view:c,pos:y}=this;return new RangeError(`Extra ${c.byteLength-y} of ${c.byteLength} byte(s) found at buffer[${l}]`)}decode(l){this.reinitializeState(),this.setBuffer(l);let c=this.doDecodeSync();if(this.hasRemaining(1))throw this.createExtraByteError(this.pos);return c}*decodeMulti(l){for(this.reinitializeState(),this.setBuffer(l);this.hasRemaining(1);)yield this.doDecodeSync()}async decodeAsync(l){let c=!1,y;for await(let E of l){if(c)throw this.createExtraByteError(this.totalPos);this.appendBuffer(E);try{y=this.doDecodeSync(),c=!0}catch(U){if(!(U instanceof e.DataViewIndexOutOfBoundsError))throw U}this.totalPos+=this.pos}if(c){if(this.hasRemaining(1))throw this.createExtraByteError(this.totalPos);return y}let{headByte:d,pos:m,totalPos:b}=this;throw new RangeError(`Insufficient data in parsing ${(0,t.prettyByte)(d)} at ${b} (${m} in the current buffer)`)}decodeArrayStream(l){return this.decodeMultiAsync(l,!0)}decodeStream(l){return this.decodeMultiAsync(l,!1)}async*decodeMultiAsync(l,c){let y=c,d=-1;for await(let m of l){if(c&&d===0)throw this.createExtraByteError(this.totalPos);this.appendBuffer(m),y&&(d=this.readArraySize(),y=!1,this.complete());try{for(;yield this.doDecodeSync(),--d!==0;);}catch(b){if(!(b instanceof e.DataViewIndexOutOfBoundsError))throw b}this.totalPos+=this.pos}}doDecodeSync(){e:for(;;){let l=this.readHeadByte(),c;if(l>=224)c=l-256;else if(l<192)if(l<128)c=l;else if(l<144){let d=l-128;if(d!==0){this.pushMapState(d),this.complete();continue e}else c={}}else if(l<160){let d=l-144;if(d!==0){this.pushArrayState(d),this.complete();continue e}else c=[]}else{let d=l-160;c=this.decodeUtf8String(d,0)}else if(l===192)c=null;else if(l===194)c=!1;else if(l===195)c=!0;else if(l===202)c=this.readF32();else if(l===203)c=this.readF64();else if(l===204)c=this.readU8();else if(l===205)c=this.readU16();else if(l===206)c=this.readU32();else if(l===207)c=this.readU64();else if(l===208)c=this.readI8();else if(l===209)c=this.readI16();else if(l===210)c=this.readI32();else if(l===211)c=this.readI64();else if(l===217){let d=this.lookU8();c=this.decodeUtf8String(d,1)}else if(l===218){let d=this.lookU16();c=this.decodeUtf8String(d,2)}else if(l===219){let d=this.lookU32();c=this.decodeUtf8String(d,4)}else if(l===220){let d=this.readU16();if(d!==0){this.pushArrayState(d),this.complete();continue e}else c=[]}else if(l===221){let d=this.readU32();if(d!==0){this.pushArrayState(d),this.complete();continue e}else c=[]}else if(l===222){let d=this.readU16();if(d!==0){this.pushMapState(d),this.complete();continue e}else c={}}else if(l===223){let d=this.readU32();if(d!==0){this.pushMapState(d),this.complete();continue e}else c={}}else if(l===196){let d=this.lookU8();c=this.decodeBinary(d,1)}else if(l===197){let d=this.lookU16();c=this.decodeBinary(d,2)}else if(l===198){let d=this.lookU32();c=this.decodeBinary(d,4)}else if(l===212)c=this.decodeExtension(1,0);else if(l===213)c=this.decodeExtension(2,0);else if(l===214)c=this.decodeExtension(4,0);else if(l===215)c=this.decodeExtension(8,0);else if(l===216)c=this.decodeExtension(16,0);else if(l===199){let d=this.lookU8();c=this.decodeExtension(d,1)}else if(l===200){let d=this.lookU16();c=this.decodeExtension(d,2)}else if(l===201){let d=this.lookU32();c=this.decodeExtension(d,4)}else throw new o.DecodeError(`Unrecognized type byte: ${(0,t.prettyByte)(l)}`);this.complete();let y=this.stack;for(;y.length>0;){let d=y[y.length-1];if(d.type===0)if(d.array[d.position]=c,d.position++,d.position===d.size)y.pop(),c=d.array;else continue e;else if(d.type===1){if(!u(c))throw new o.DecodeError("The type of key must be string or number but "+typeof c);if(c==="__proto__")throw new o.DecodeError("The key __proto__ is not allowed");d.key=c,d.type=2;continue e}else if(d.map[d.key]=c,d.readCount++,d.readCount===d.size)y.pop(),c=d.map;else{d.key=null,d.type=1;continue e}}return c}}readHeadByte(){return this.headByte===p&&(this.headByte=this.readU8()),this.headByte}complete(){this.headByte=p}readArraySize(){let l=this.readHeadByte();switch(l){case 220:return this.readU16();case 221:return this.readU32();default:{if(l<160)return l-144;throw new o.DecodeError(`Unrecognized array type byte: ${(0,t.prettyByte)(l)}`)}}}pushMapState(l){if(l>this.maxMapLength)throw new o.DecodeError(`Max length exceeded: map length (${l}) > maxMapLengthLength (${this.maxMapLength})`);this.stack.push({type:1,size:l,key:null,readCount:0,map:{}})}pushArrayState(l){if(l>this.maxArrayLength)throw new o.DecodeError(`Max length exceeded: array length (${l}) > maxArrayLength (${this.maxArrayLength})`);this.stack.push({type:0,size:l,array:new Array(l),position:0})}decodeUtf8String(l,c){var y;if(l>this.maxStrLength)throw new o.DecodeError(`Max length exceeded: UTF-8 byte length (${l}) > maxStrLength (${this.maxStrLength})`);if(this.bytes.byteLength<this.pos+c+l)throw v;let d=this.pos+c,m;return this.stateIsMapKey()&&!((y=this.keyDecoder)===null||y===void 0)&&y.canBeCached(l)?m=this.keyDecoder.decode(this.bytes,d,l):l>a.TEXT_DECODER_THRESHOLD?m=(0,a.utf8DecodeTD)(this.bytes,d,l):m=(0,a.utf8DecodeJs)(this.bytes,d,l),this.pos+=c+l,m}stateIsMapKey(){return this.stack.length>0?this.stack[this.stack.length-1].type===1:!1}decodeBinary(l,c){if(l>this.maxBinLength)throw new o.DecodeError(`Max length exceeded: bin length (${l}) > maxBinLength (${this.maxBinLength})`);if(!this.hasRemaining(l+c))throw v;let y=this.pos+c,d=this.bytes.subarray(y,y+l);return this.pos+=c+l,d}decodeExtension(l,c){if(l>this.maxExtLength)throw new o.DecodeError(`Max length exceeded: ext length (${l}) > maxExtLength (${this.maxExtLength})`);let y=this.view.getInt8(this.pos+c),d=this.decodeBinary(l,c+1);return this.extensionCodec.decode(d,y,this.context)}lookU8(){return this.view.getUint8(this.pos)}lookU16(){return this.view.getUint16(this.pos)}lookU32(){return this.view.getUint32(this.pos)}readU8(){let l=this.view.getUint8(this.pos);return this.pos++,l}readI8(){let l=this.view.getInt8(this.pos);return this.pos++,l}readU16(){let l=this.view.getUint16(this.pos);return this.pos+=2,l}readI16(){let l=this.view.getInt16(this.pos);return this.pos+=2,l}readU32(){let l=this.view.getUint32(this.pos);return this.pos+=4,l}readI32(){let l=this.view.getInt32(this.pos);return this.pos+=4,l}readU64(){let l=(0,s.getUint64)(this.view,this.pos);return this.pos+=8,l}readI64(){let l=(0,s.getInt64)(this.view,this.pos);return this.pos+=8,l}readF32(){let l=this.view.getFloat32(this.pos);return this.pos+=4,l}readF64(){let l=this.view.getFloat64(this.pos);return this.pos+=8,l}};e.Decoder=k}),je=S(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.decodeMulti=e.decode=e.defaultDecodeOptions=void 0;var t=ce();e.defaultDecodeOptions={};function r(a,i=e.defaultDecodeOptions){return new t.Decoder(i.extensionCodec,i.context,i.maxStrLength,i.maxBinLength,i.maxArrayLength,i.maxMapLength,i.maxExtLength).decode(a)}e.decode=r;function s(a,i=e.defaultDecodeOptions){return new t.Decoder(i.extensionCodec,i.context,i.maxStrLength,i.maxBinLength,i.maxArrayLength,i.maxMapLength,i.maxExtLength).decodeMulti(a)}e.decodeMulti=s}),Et=S(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.ensureAsyncIterable=e.asyncIterableFromStream=e.isAsyncIterable=void 0;function t(i){return i[Symbol.asyncIterator]!=null}e.isAsyncIterable=t;function r(i){if(i==null)throw new Error("Assertion Failure: value must not be null nor undefined")}async function*s(i){let n=i.getReader();try{for(;;){let{done:o,value:u}=await n.read();if(o)return;r(u),yield u}}finally{n.releaseLock()}}e.asyncIterableFromStream=s;function a(i){return t(i)?i:s(i)}e.ensureAsyncIterable=a}),Tt=S(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.decodeStream=e.decodeMultiStream=e.decodeArrayStream=e.decodeAsync=void 0;var t=ce(),r=Et(),s=je();async function a(u,p=s.defaultDecodeOptions){let f=(0,r.ensureAsyncIterable)(u);return new t.Decoder(p.extensionCodec,p.context,p.maxStrLength,p.maxBinLength,p.maxArrayLength,p.maxMapLength,p.maxExtLength).decodeAsync(f)}e.decodeAsync=a;function i(u,p=s.defaultDecodeOptions){let f=(0,r.ensureAsyncIterable)(u);return new t.Decoder(p.extensionCodec,p.context,p.maxStrLength,p.maxBinLength,p.maxArrayLength,p.maxMapLength,p.maxExtLength).decodeArrayStream(f)}e.decodeArrayStream=i;function n(u,p=s.defaultDecodeOptions){let f=(0,r.ensureAsyncIterable)(u);return new t.Decoder(p.extensionCodec,p.context,p.maxStrLength,p.maxBinLength,p.maxArrayLength,p.maxMapLength,p.maxExtLength).decodeStream(f)}e.decodeMultiStream=n;function o(u,p=s.defaultDecodeOptions){return n(u,p)}e.decodeStream=o}),Rt=S(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.decodeTimestampExtension=e.encodeTimestampExtension=e.decodeTimestampToTimeSpec=e.encodeTimeSpecToTimestamp=e.encodeDateToTimeSpec=e.EXT_TIMESTAMP=e.ExtData=e.ExtensionCodec=e.Encoder=e.DataViewIndexOutOfBoundsError=e.DecodeError=e.Decoder=e.decodeStream=e.decodeMultiStream=e.decodeArrayStream=e.decodeAsync=e.decodeMulti=e.decode=e.encode=void 0;var t=gt();Object.defineProperty(e,"encode",{enumerable:!0,get:function(){return t.encode}});var r=je();Object.defineProperty(e,"decode",{enumerable:!0,get:function(){return r.decode}}),Object.defineProperty(e,"decodeMulti",{enumerable:!0,get:function(){return r.decodeMulti}});var s=Tt();Object.defineProperty(e,"decodeAsync",{enumerable:!0,get:function(){return s.decodeAsync}}),Object.defineProperty(e,"decodeArrayStream",{enumerable:!0,get:function(){return s.decodeArrayStream}}),Object.defineProperty(e,"decodeMultiStream",{enumerable:!0,get:function(){return s.decodeMultiStream}}),Object.defineProperty(e,"decodeStream",{enumerable:!0,get:function(){return s.decodeStream}});var a=ce();Object.defineProperty(e,"Decoder",{enumerable:!0,get:function(){return a.Decoder}}),Object.defineProperty(e,"DataViewIndexOutOfBoundsError",{enumerable:!0,get:function(){return a.DataViewIndexOutOfBoundsError}});var i=ue();Object.defineProperty(e,"DecodeError",{enumerable:!0,get:function(){return i.DecodeError}});var n=Ue();Object.defineProperty(e,"Encoder",{enumerable:!0,get:function(){return n.Encoder}});var o=he();Object.defineProperty(e,"ExtensionCodec",{enumerable:!0,get:function(){return o.ExtensionCodec}});var u=Se();Object.defineProperty(e,"ExtData",{enumerable:!0,get:function(){return u.ExtData}});var p=xe();Object.defineProperty(e,"EXT_TIMESTAMP",{enumerable:!0,get:function(){return p.EXT_TIMESTAMP}}),Object.defineProperty(e,"encodeDateToTimeSpec",{enumerable:!0,get:function(){return p.encodeDateToTimeSpec}}),Object.defineProperty(e,"encodeTimeSpecToTimestamp",{enumerable:!0,get:function(){return p.encodeTimeSpecToTimestamp}}),Object.defineProperty(e,"decodeTimestampToTimeSpec",{enumerable:!0,get:function(){return p.decodeTimestampToTimeSpec}}),Object.defineProperty(e,"encodeTimestampExtension",{enumerable:!0,get:function(){return p.encodeTimestampExtension}}),Object.defineProperty(e,"decodeTimestampExtension",{enumerable:!0,get:function(){return p.decodeTimestampExtension}})}),_t=S((e,t)=>{t.exports={Receiver:"",Sender:"",WebSocket:"",WebSocketServer:"",createWebSocketStream:"",default:""}}),Oe=S((e,t)=>{t.exports={BroadcastChannel:"",MessageChannel:"",MessagePort:"",SHARE_ENV:"",Worker:"",default:"",getEnvironmentData:"",isMainThread:"",markAsUntransferable:"",moveMessagePortToContext:"",parentPort:"",postMessageToThread:"",receiveMessageOnPort:"",resourceLimits:"",setEnvironmentData:"",threadId:"",workerData:""}}),B=class extends Error{constructor(e){super(e),this.name=this.constructor.name,Object.setPrototypeOf(this,new.target.prototype)}},P=class extends B{},N=class extends B{},G=class extends B{},O=typeof process<"u"&&process.release&&process.release.name==="node";if(!globalThis.document){if(!globalThis.importScripts){if(!O)throw new B("Cannot determine runtime environment")}}var I={null:0,symbol:1,pairlist:2,closure:3,environment:4,promise:5,call:6,special:7,builtin:8,string:9,logical:10,integer:13,double:14,complex:15,character:16,dots:17,any:18,list:19,expression:20,bytecode:21,pointer:22,weakref:23,raw:24,s4:25,new:30,free:31,function:99};function de(e){return!!e&&typeof e=="object"&&Object.keys(I).includes(e.type)}function Y(e){return!!e&&typeof e=="object"&&"re"in e&&"im"in e}var h={};function St(e){Object.keys(e).forEach(t=>h._free(e[t]))}function re(e){return h._Rf_protect(L(e)),e}function T(e,t){return h._Rf_protect(L(e)),++t.n,e}function xt(e){let t=h._malloc(4);return h._R_ProtectWithIndex(L(e),t),{loc:h.getValue(t,"i32"),ptr:t}}function At(e){h._Rf_unprotect(1),h._free(e.ptr)}function Ut(e,t){return h._R_Reprotect(L(e),t.loc),e}function x(e){h._Rf_unprotect(e)}function De(e,t,r){h._Rf_defineVar(L(t),L(r),L(e))}function ke(e,t){let r={},s={n:0};try{let a=new Pe(t);T(a,s),r.code=h.allocateUTF8(e);let i=h._R_ParseEvalString(r.code,a.ptr);return g.wrap(i)}finally{St(r),x(s.n)}}function se(e,t){return h.getWasmTableEntry(h.GOT.ffi_safe_eval.value)(L(e),L(t))}var jt=new WeakMap;function Ot(e,t){return jt.set(e,t),e}function Dt(e){return typeof e=="string"&&e.length===Ie}var Ie=63;function Ce(){let e=Array.from({length:4},kt).join("-");if(e.length!==Ie)throw new Error("comlink internal error: UUID has the wrong length");return e}function kt(){let e=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16),t=15-e.length;return t>0&&(e=Array.from({length:t},()=>0).join("")+e),e}function L(e){return ie(e)?e.ptr:e}function F(e,t){if(h._TYPEOF(e.ptr)!==I[t])throw new Error(`Unexpected object type "${e.type()}" when expecting type "${t}"`)}function Le(e){if(de(e))return new(Ne(e.type))(e);if(typeof e>"u")return new pe;if(e&&typeof e=="object"&&"type"in e&&e.type==="null")return new pe;if(e===null)return new Z({type:"logical",names:null,values:[null]});if(typeof e=="boolean")return new Z(e);if(typeof e=="number")return new ge(e);if(typeof e=="string")return new W(e);if(Y(e))return new Me(e);if(ArrayBuffer.isView(e)||e instanceof ArrayBuffer)return new Be(e);if(Array.isArray(e))return It(e);if(typeof e=="object")return we.fromObject(e);throw new Error("R object construction for this JS object is not yet supported.")}function It(e){let t={n:0};if(e.every(r=>r&&typeof r=="object"&&!ie(r)&&!Y(r))){let r=e,s=r.every(i=>Object.keys(i).filter(n=>!Object.keys(r[0]).includes(n)).length===0&&Object.keys(r[0]).filter(n=>!Object.keys(i).includes(n)).length===0),a=r.every(i=>Object.values(i).every(n=>We(n)||Fe(n)));if(s&&a)return we.fromD3(r)}if(e.every(r=>typeof r=="boolean"||r===null))return new Z(e);if(e.every(r=>typeof r=="number"||r===null))return new ge(e);if(e.every(r=>typeof r=="string"||r===null))return new W(e);try{let r=new q([new C("c"),...e]);return T(r,t),r.eval()}finally{x(t.n)}}var _=class{constructor(e){this.ptr=e}type(){let e=h._TYPEOF(this.ptr);return Object.keys(I).find(t=>I[t]===e)}},g=class K extends _{constructor(t){if(!(t instanceof _))return Le(t);super(t.ptr)}static wrap(t){let r=h._TYPEOF(t),s=Object.keys(I)[Object.values(I).indexOf(r)];return new(Ne(s))(new _(t))}get[Symbol.toStringTag](){return`RObject:${this.type()}`}static getPersistentObject(t){return j[t]}getPropertyValue(t){return this[t]}inspect(){ke(".Internal(inspect(x))",{x:this})}isNull(){return h._TYPEOF(this.ptr)===I.null}isNa(){try{let t=ke("is.na(x)",{x:this});return re(t),t.toBoolean()}finally{x(1)}}isUnbound(){return this.ptr===j.unboundValue.ptr}attrs(){return fe.wrap(h._ATTRIB(this.ptr))}class(){let t={n:0},r=new q([new C("class"),this]);T(r,t);try{return r.eval()}finally{x(t.n)}}setNames(t){let r;if(t===null)r=j.null;else if(Array.isArray(t)&&t.every(s=>typeof s=="string"||s===null))r=new W(t);else throw new Error("Argument to setNames must be null or an Array of strings or null");return h._Rf_setAttrib(this.ptr,j.namesSymbol.ptr,r.ptr),this}names(){let t=W.wrap(h._Rf_getAttrib(this.ptr,j.namesSymbol.ptr));return t.isNull()?null:t.toArray()}includes(t){let r=this.names();return r&&r.includes(t)}toJs(t={depth:0},r=1){throw new Error("This R object cannot be converted to JS")}subset(t){return this.#e(t,j.bracketSymbol.ptr)}get(t){return this.#e(t,j.bracket2Symbol.ptr)}getDollar(t){return this.#e(t,j.dollarSymbol.ptr)}#e(t,r){let s={n:0};try{let a=new K(t);T(a,s);let i=h._Rf_lang3(r,this.ptr,a.ptr);return T(i,s),K.wrap(se(i,j.baseEnv))}finally{x(s.n)}}pluck(...t){let r=xt(j.null);try{let s=(i,n)=>{let o=i.get(n);return Ut(o,r)},a=t.reduce(s,this);return a.isNull()?void 0:a}finally{At(r)}}set(t,r){let s={n:0};try{let a=new K(t);T(a,s);let i=new K(r);T(i,s);let n=new C("[[<-"),o=h._Rf_lang4(n.ptr,this.ptr,a.ptr,i.ptr);return T(o,s),K.wrap(se(o,j.baseEnv))}finally{x(s.n)}}static getMethods(t){let r=new Set,s=t;do Object.getOwnPropertyNames(s).map(a=>r.add(a));while(s=Object.getPrototypeOf(s));return[...r.keys()].filter(a=>typeof t[a]=="function")}},pe=class extends g{constructor(){return super(new _(h.getValue(h._R_NilValue,"*"))),this}toJs(){return{type:"null"}}},C=class extends g{constructor(e){if(e instanceof _){F(e,"symbol"),super(e);return}let t=h.allocateUTF8(e);try{super(new _(h._Rf_install(t)))}finally{h._free(t)}}toJs(){let e=this.toObject();return{type:"symbol",printname:e.printname,symvalue:e.symvalue,internal:e.internal}}toObject(){return{printname:this.printname().isUnbound()?null:this.printname().toString(),symvalue:this.symvalue().isUnbound()?null:this.symvalue().ptr,internal:this.internal().isNull()?null:this.internal().ptr}}toString(){return this.printname().toString()}printname(){return me.wrap(h._PRINTNAME(this.ptr))}symvalue(){return g.wrap(h._SYMVALUE(this.ptr))}internal(){return g.wrap(h._INTERNAL(this.ptr))}},fe=class tt extends g{constructor(t){if(t instanceof _)return F(t,"pairlist"),super(t),this;let r={n:0};try{let{names:s,values:a}=H(t),i=tt.wrap(h._Rf_allocList(a.length));T(i,r);for(let[n,o]=[0,i];!o.isNull();[n,o]=[n+1,o.cdr()])o.setcar(new g(a[n]));i.setNames(s),super(i)}finally{x(r.n)}}get length(){return this.toArray().length}toArray(t={depth:1}){return this.toJs(t).values}toObject({allowDuplicateKey:t=!0,allowEmptyKey:r=!1,depth:s=-1}={}){let a=this.entries({depth:s}),i=a.map(([n])=>n);if(!t&&new Set(i).size!==i.length)throw new Error("Duplicate key when converting pairlist without allowDuplicateKey enabled");if(!r&&i.some(n=>!n))throw new Error("Empty or null key when converting pairlist without allowEmptyKey enabled");return Object.fromEntries(a.filter((n,o)=>a.findIndex(u=>u[0]===n[0])===o))}entries(t={depth:1}){let r=this.toJs(t);return r.values.map((s,a)=>[r.names?r.names[a]:null,s])}toJs(t={depth:0},r=1){let s=[],a=!1,i=[];for(let n=this;!n.isNull();n=n.cdr()){let o=n.tag();o.isNull()?s.push(""):(a=!0,s.push(o.toString())),t.depth&&r>=t.depth?i.push(n.car()):i.push(n.car().toJs(t,r+1))}return{type:"pairlist",names:a?s:null,values:i}}includes(t){return t in this.toObject()}setcar(t){h._SETCAR(this.ptr,t.ptr)}car(){return g.wrap(h._CAR(this.ptr))}cdr(){return g.wrap(h._CDR(this.ptr))}tag(){return g.wrap(h._TAG(this.ptr))}},q=class rt extends g{constructor(t){if(t instanceof _)return F(t,"call"),super(t),this;let r={n:0};try{let{values:s}=H(t),a=s.map(n=>T(new g(n),r)),i=rt.wrap(h._Rf_allocVector(I.call,s.length));T(i,r);for(let[n,o]=[0,i];!o.isNull();[n,o]=[n+1,o.cdr()])o.setcar(a[n]);super(i)}finally{x(r.n)}}setcar(t){h._SETCAR(this.ptr,t.ptr)}car(){return g.wrap(h._CAR(this.ptr))}cdr(){return g.wrap(h._CDR(this.ptr))}eval(){return h.webr.evalR(this,{env:j.baseEnv})}capture(t={}){return h.webr.captureR(this,t)}deparse(){let t={n:0};try{let r=h._Rf_lang2(new C("deparse1").ptr,h._Rf_lang2(new C("quote").ptr,this.ptr));T(r,t);let s=W.wrap(se(r,j.baseEnv));return T(s,t),s.toString()}finally{x(t.n)}}},ye=class st extends g{constructor(t,r=null){if(t instanceof _){if(F(t,"list"),super(t),r){if(r.length!==this.length)throw new Error("Can't construct named `RList`. Supplied `names` must be the same length as the list.");this.setNames(r)}return this}let s={n:0};try{let a=H(t),i=h._Rf_allocVector(I.list,a.values.length);T(i,s),a.values.forEach((o,u)=>{Mt(o)?h._SET_VECTOR_ELT(i,u,new st(o).ptr):h._SET_VECTOR_ELT(i,u,new g(o).ptr)});let n=r||a.names;if(n&&n.length!==a.values.length)throw new Error("Can't construct named `RList`. Supplied `names` must be the same length as the list.");g.wrap(i).setNames(n),super(new _(i))}finally{x(s.n)}}get length(){return h._LENGTH(this.ptr)}isDataFrame(){let t=fe.wrap(h._ATTRIB(this.ptr)).get("class");return!t.isNull()&&t.toArray().includes("data.frame")}toArray(t={depth:1}){return this.toJs(t).values}toObject({allowDuplicateKey:t=!0,allowEmptyKey:r=!1,depth:s=-1}={}){let a=this.entries({depth:s}),i=a.map(([n])=>n);if(!t&&new Set(i).size!==i.length)throw new Error("Duplicate key when converting list without allowDuplicateKey enabled");if(!r&&i.some(n=>!n))throw new Error("Empty or null key when converting list without allowEmptyKey enabled");return Object.fromEntries(a.filter((n,o)=>a.findIndex(u=>u[0]===n[0])===o))}toD3(){if(!this.isDataFrame())throw new Error("Can't convert R list object to D3 format. Object must be of class 'data.frame'.");return this.entries().reduce((t,r)=>(r[1].forEach((s,a)=>t[a]=Object.assign(t[a]||{},{[r[0]]:s})),t),[])}entries(t={depth:-1}){let r=this.toJs(t);return this.isDataFrame()&&t.depth<0&&(r.values=r.values.map(s=>s.toArray())),r.values.map((s,a)=>[r.names?r.names[a]:null,s])}toJs(t={depth:0},r=1){return{type:"list",names:this.names(),values:[...Array(this.length).keys()].map(s=>t.depth&&r>=t.depth?this.get(s+1):this.get(s+1).toJs(t,r+1))}}},we=class Re extends ye{constructor(t){if(t instanceof _){if(super(t),!this.isDataFrame())throw new Error("Can't construct `RDataFrame`. Supplied R object is not a `data.frame`.");return this}return Re.fromObject(t)}static fromObject(t){let{names:r,values:s}=H(t),a={n:0};try{let i=!!r&&r.length>0&&r.every(o=>o),n=s.length>0&&s.every(o=>Array.isArray(o)||ArrayBuffer.isView(o)||o instanceof ArrayBuffer);if(i&&n){let o=s,u=o.every(f=>f.length===o[0].length),p=o.every(f=>We(f[0])||Fe(f[0]));if(u&&p){let f=new ye({type:"list",names:r,values:o.map(v=>Le(v))});T(f,a);let w=new q([new C("as.data.frame"),f]);return T(w,a),new Re(w.eval())}}}finally{x(a.n)}throw new Error("Can't construct `data.frame`. Source object is not eligible.")}static fromD3(t){return this.fromObject(Object.fromEntries(Object.keys(t[0]).map(r=>[r,t.map(s=>s[r])])))}},ne=class extends g{exec(...e){let t={n:0};try{let r=new q([this,...e]);return T(r,t),r.eval()}finally{x(t.n)}}capture(e={},...t){let r={n:0};try{let s=new q([this,...t]);return T(s,r),s.capture(e)}finally{x(r.n)}}},me=(ee=class extends g{constructor(e){if(e instanceof _){F(e,"string"),super(e);return}let t=h.allocateUTF8(e);try{super(new _(h._Rf_mkCharCE(t,ee.CEType.CE_UTF8)))}finally{h._free(t)}}toString(){let e=h._vmaxget();try{return h.UTF8ToString(h._Rf_translateCharUTF8(this.ptr))}finally{h._vmaxset(e)}}toJs(){return{type:"string",value:this.toString()}}},ee.CEType={CE_NATIVE:0,CE_UTF8:1,CE_LATIN1:2,CE_BYTES:3,CE_SYMBOL:5,CE_ANY:99},ee),Pe=class extends g{constructor(e={}){if(e instanceof _)return F(e,"environment"),super(e),this;let t=0;try{let{names:r,values:s}=H(e),a=re(h._R_NewEnv(j.globalEnv.ptr,0,0));++t,s.forEach((i,n)=>{let o=r?r[n]:null;if(!o)throw new Error("Can't create object in new environment with empty symbol name");let u=new C(o),p=re(new g(i));try{De(a,u,p)}finally{x(1)}}),super(new _(a))}finally{x(t)}}ls(e=!1,t=!0){return W.wrap(h._R_lsInternal3(this.ptr,Number(e),Number(t))).toArray()}bind(e,t){let r=new C(e),s=re(new g(t));try{De(this,r,s)}finally{x(1)}}names(){return this.ls(!0,!0)}frame(){return g.wrap(h._FRAME(this.ptr))}subset(e){if(typeof e=="number")throw new Error("Object of type environment is not subsettable");return this.getDollar(e)}toObject({depth:e=-1}={}){let t=this.names();return Object.fromEntries([...Array(t.length).keys()].map(r=>{let s=this.getDollar(t[r]);return[t[r],e<0?s:s.toJs({depth:e})]}))}toJs(e={depth:0},t=1){let r=this.names(),s=[...Array(r.length).keys()].map(a=>e.depth&&t>=e.depth?this.getDollar(r[a]):this.getDollar(r[a]).toJs(e,t+1));return{type:"environment",names:r,values:s}}},J=class extends g{constructor(e,t,r){if(e instanceof _)return F(e,t),super(e),this;let s={n:0};try{let{names:a,values:i}=H(e),n=h._Rf_allocVector(I[t],i.length);T(n,s),i.forEach(r(n)),g.wrap(n).setNames(a),super(new _(n))}finally{x(s.n)}}get length(){return h._LENGTH(this.ptr)}get(e){return super.get(e)}subset(e){return super.subset(e)}getDollar(){throw new Error("$ operator is invalid for atomic vectors")}detectMissing(){let e={n:0};try{let t=h._Rf_lang2(new C("is.na").ptr,this.ptr);T(t,e);let r=Z.wrap(se(t,j.baseEnv));T(r,e);let s=r.toTypedArray();return Array.from(s).map(a=>!!a)}finally{x(e.n)}}toArray(){let e=this.toTypedArray();return this.detectMissing().map((t,r)=>t?null:e[r])}toObject({allowDuplicateKey:e=!0,allowEmptyKey:t=!1}={}){let r=this.entries(),s=r.map(([a])=>a);if(!e&&new Set(s).size!==s.length)throw new Error("Duplicate key when converting atomic vector without allowDuplicateKey enabled");if(!t&&s.some(a=>!a))throw new Error("Empty or null key when converting atomic vector without allowEmptyKey enabled");return Object.fromEntries(r.filter((a,i)=>r.findIndex(n=>n[0]===a[0])===i))}entries(){let e=this.toArray(),t=this.names();return e.map((r,s)=>[t?t[s]:null,r])}toJs(){return{type:this.type(),names:this.names(),values:this.toArray()}}},Z=class nt extends J{constructor(t){super(t,"logical",nt.#e)}static#e=t=>{let r=h._LOGICAL(t),s=h.getValue(h._R_NaInt,"i32");return(a,i)=>{h.setValue(r+4*i,a===null?s:!!a,"i32")}};getBoolean(t){return this.get(t).toArray()[0]}toBoolean(){if(this.length!==1)throw new Error("Can't convert atomic vector of length > 1 to a scalar JS value");let t=this.getBoolean(1);if(t===null)throw new Error("Can't convert missing value `NA` to a JS boolean");return t}toTypedArray(){return new Int32Array(h.HEAP32.subarray(h._LOGICAL(this.ptr)/4,h._LOGICAL(this.ptr)/4+this.length))}toArray(){let t=this.toTypedArray();return this.detectMissing().map((r,s)=>r?null:!!t[s])}},Ct=class it extends J{constructor(t){super(t,"integer",it.#e)}static#e=t=>{let r=h._INTEGER(t),s=h.getValue(h._R_NaInt,"i32");return(a,i)=>{h.setValue(r+4*i,a===null?s:Math.round(Number(a)),"i32")}};getNumber(t){return this.get(t).toArray()[0]}toNumber(){if(this.length!==1)throw new Error("Can't convert atomic vector of length > 1 to a scalar JS value");let t=this.getNumber(1);if(t===null)throw new Error("Can't convert missing value `NA` to a JS number");return t}toTypedArray(){return new Int32Array(h.HEAP32.subarray(h._INTEGER(this.ptr)/4,h._INTEGER(this.ptr)/4+this.length))}},ge=class at extends J{constructor(t){super(t,"double",at.#e)}static#e=t=>{let r=h._REAL(t),s=h.getValue(h._R_NaReal,"double");return(a,i)=>{h.setValue(r+8*i,a===null?s:a,"double")}};getNumber(t){return this.get(t).toArray()[0]}toNumber(){if(this.length!==1)throw new Error("Can't convert atomic vector of length > 1 to a scalar JS value");let t=this.getNumber(1);if(t===null)throw new Error("Can't convert missing value `NA` to a JS number");return t}toTypedArray(){return new Float64Array(h.HEAPF64.subarray(h._REAL(this.ptr)/8,h._REAL(this.ptr)/8+this.length))}},Me=class ot extends J{constructor(t){super(t,"complex",ot.#e)}static#e=t=>{let r=h._COMPLEX(t),s=h.getValue(h._R_NaReal,"double");return(a,i)=>{h.setValue(r+8*(2*i),a===null?s:a.re,"double"),h.setValue(r+8*(2*i+1),a===null?s:a.im,"double")}};getComplex(t){return this.get(t).toArray()[0]}toComplex(){if(this.length!==1)throw new Error("Can't convert atomic vector of length > 1 to a scalar JS value");let t=this.getComplex(1);if(t===null)throw new Error("Can't convert missing value `NA` to a JS object");return t}toTypedArray(){return new Float64Array(h.HEAPF64.subarray(h._COMPLEX(this.ptr)/8,h._COMPLEX(this.ptr)/8+2*this.length))}toArray(){let t=this.toTypedArray();return this.detectMissing().map((r,s)=>r?null:{re:t[2*s],im:t[2*s+1]})}},W=class lt extends J{constructor(t){super(t,"character",lt.#e)}static#e=t=>(r,s)=>{r===null?h._SET_STRING_ELT(t,s,j.naString.ptr):h._SET_STRING_ELT(t,s,new me(r).ptr)};getString(t){return this.get(t).toArray()[0]}toString(){if(this.length!==1)throw new Error("Can't convert atomic vector of length > 1 to a scalar JS value");let t=this.getString(1);if(t===null)throw new Error("Can't convert missing value `NA` to a JS string");return t}toTypedArray(){return new Uint32Array(h.HEAPU32.subarray(h._STRING_PTR(this.ptr)/4,h._STRING_PTR(this.ptr)/4+this.length))}toArray(){let t=h._vmaxget();try{return this.detectMissing().map((r,s)=>r?null:h.UTF8ToString(h._Rf_translateCharUTF8(h._STRING_ELT(this.ptr,s))))}finally{h._vmaxset(t)}}},Be=class ut extends J{constructor(t){t instanceof ArrayBuffer&&(t=new Uint8Array(t)),super(t,"raw",ut.#e)}static#e=t=>{let r=h._RAW(t);return(s,a)=>{h.setValue(r+a,Number(s),"i8")}};getNumber(t){return this.get(t).toArray()[0]}toNumber(){if(this.length!==1)throw new Error("Can't convert atomic vector of length > 1 to a scalar JS value");let t=this.getNumber(1);if(t===null)throw new Error("Can't convert missing value `NA` to a JS number");return t}toTypedArray(){return new Uint8Array(h.HEAPU8.subarray(h._RAW(this.ptr),h._RAW(this.ptr)+this.length))}};function H(e){return de(e)?e:Array.isArray(e)||ArrayBuffer.isView(e)?{names:null,values:e}:e&&typeof e=="object"&&!Y(e)?{names:Object.keys(e),values:Object.values(e)}:{names:null,values:[e]}}function Ne(e){let t={object:g,null:pe,symbol:C,pairlist:fe,closure:ne,environment:Pe,call:q,special:ne,builtin:ne,string:me,logical:Z,integer:Ct,double:ge,complex:Me,character:W,list:ye,raw:Be,function:ne,dataframe:we};return e in t?t[e]:g}function ie(e){return e instanceof g}function Fe(e){let t=["logical","integer","double","complex","character"];return ie(e)&&t.includes(e.type())||ie(e)&&e.isNa()}function We(e){return e===null||typeof e=="number"||typeof e=="boolean"||typeof e=="string"||Y(e)}var j;function ae(){let e={resolve:()=>{},reject:()=>{},promise:Promise.resolve()},t=new Promise((r,s)=>{e.resolve=r,e.reject=s});return e.promise=t,e}function Lt(e){return new Promise(t=>setTimeout(t,e))}function M(e,t,r,...s){return e==null||Pt(e)?e:e instanceof ArrayBuffer?new Uint8Array(e):t(e)?r(e,...s):Array.isArray(e)||ArrayBuffer.isView(e)?e.map(a=>M(a,t,r,...s)):e instanceof _?e:typeof e=="object"?Object.fromEntries(Object.entries(e).map(([a,i])=>[a,M(i,t,r,...s)])):e}function be(e,t,r,s,a=!0){let i=new XMLHttpRequest;i.open("get",e,a),i.onload=()=>{if(i.status>=200&&i.status<300)try{let n=new Worker(URL.createObjectURL(new Blob([i.responseText])),s);t(n)}catch(n){if(r)r(n instanceof Error?n:new Error(String(n)));else throw n}else r?r(new Error(`Worker loading error: HTTP ${i.status}`)):console.error(`HTTP Error: ${i.status}`)},i.onerror=()=>{r?r(new Error(`Network error loading ${e}`)):console.error(`Network error loading ${e}`)},i.send()}function Ve(e){if(O)return!1;let t=new URL(location.href),r=new URL(e,location.origin);return!(t.host===r.host&&t.port===r.port&&t.protocol===r.protocol)}function Pt(e){return typeof ImageBitmap<"u"&&e instanceof ImageBitmap}function Mt(e){return typeof e=="object"&&e!==null&&!Array.isArray(e)&&!ArrayBuffer.isView(e)&&!Y(e)&&!de(e)&&!(e instanceof Date)&&!(e instanceof RegExp)&&!(e instanceof Error)&&!(e instanceof _)&&Object.getPrototypeOf(e)===Object.prototype}var Bt=mt(Rt()),Nt=new TextEncoder;async function X(e,t,r){try{let{taskId:s,sizeBuffer:a,dataBuffer:i,signalBuffer:n}=t,o=(0,Bt.encode)(r),u=o.length<=i.length;if(Atomics.store(a,0,o.length),Atomics.store(a,1,+u),!u){let[p,f]=Ft(e);i.set(Nt.encode(p)),await $e(n,s),i=(await f).dataBuffer}i.set(o),Atomics.store(a,1,1),await $e(n,s)}catch(s){console.warn(s)}}function Ft(e){let t=Ce();return[t,new Promise(r=>{O?e.once("message",s=>{!s.id||s.id!==t||r(s)}):e.addEventListener("message",function s(a){!a.data||!a.data.id||a.data.id!==t||(e.removeEventListener("message",s),r(a.data))}),e.start&&e.start()})]}async function $e(e,t){let r=(t>>1)%32,s=1;for(;Atomics.compareExchange(e,r+1,0,t)!==0;)await Lt(s),s<32&&(s*=2);Atomics.or(e,0,1<<r),Atomics.notify(e,0)}var ve=class{#e;#t;constructor(){this.#t=[],this.#e=[]}reset(){this.#t=[],this.#e=[]}put(e){this.#t.length||this.#r(),this.#t.shift()(e)}async get(){return this.#e.length||this.#r(),this.#e.shift()}isEmpty(){return!this.#e.length}isBlocked(){return!!this.#t.length}get length(){return this.#e.length-this.#t.length}#r(){this.#e.push(new Promise(e=>{this.#t.push(e)}))}};function Wt(e,t){return ze({type:"request",data:{uuid:Ce(),msg:e}},t)}function Vt(e,t,r){return ze({type:"response",data:{uuid:e,resp:t}},r)}function ze(e,t){return t&&Ot(e,t),e}function $t(e){let t=new P(e.obj.message);return e.obj.name=="ErrnoError"?t.message=`ErrnoError: ${String(e.obj.errno)}`:e.obj.name!=="Error"&&(t.name=e.obj.name),t.stack=e.obj.stack,t}function zt(e){return!!e&&typeof e=="object"&&"payloadType"in e&&"obj"in e}function qe(e){return zt(e)&&e.payloadType==="ptr"}var Je=class{constructor(){this.inputQueue=new ve,this.outputQueue=new ve,this.systemQueue=new ve,this.eventQueue=new Array,this.#e=new Map,this.#t=!1}#e;#t;async read(){return await this.outputQueue.get()}async flush(){let e=[];for(;!this.outputQueue.isEmpty();)e.push(await this.read());return e}async readSystem(){return await this.systemQueue.get()}write(e){if(this.#t)throw new N("The webR communication channel has been closed.");this.inputQueue.put(e)}async request(e,t){let r=Wt(e,t),{resolve:s,reject:a,promise:i}=ae();return this.#e.set(r.data.uuid,{resolve:s,reject:a}),this.write(r),i}putClosedMessage(){this.#t=!0,this.outputQueue.put({type:"closed"})}resolveResponse(e){let t=e.data.uuid,r=this.#e.get(t);if(r){let s=e.data.resp.data;this.#e.delete(t),s.payloadType==="err"?r.reject($t(s)):r.resolve(s)}else console.warn("Can't find request.")}};new TextDecoder("utf-8");var qt=class{constructor(e){this.chan=e,this.WebSocket=O?_t():WebSocket}#e=new Map;new(e,t,r){let s=new this.WebSocket(t,r||[]);s.binaryType="arraybuffer",s.addEventListener("open",()=>{this.chan.emit({type:"websocket-open",data:{uuid:e}})}),s.addEventListener("message",a=>{let i=new Uint8Array(a.data);this.chan.emit({type:"websocket-message",data:{uuid:e,data:i}})}),s.addEventListener("close",a=>{this.chan.emit({type:"websocket-close",data:{uuid:e,code:a.code,reason:a.reason}})}),s.addEventListener("error",()=>{this.chan.emit({type:"websocket-error",data:{uuid:e}})}),this.#e.set(e,s)}send(e,t){this.#e.get(e)?.send(t)}close(e,t,r){this.#e.get(e)?.close(t,r),this.#e.delete(e)}};O&&(globalThis.CloseEvent=class extends Event{constructor(e,t={}){super(e,t),this.wasClean=t.wasClean||!1,this.code=t.code||0,this.reason=t.reason||""}});var Jt=class{constructor(e){this.chan=e}#e=new Map;new(e,t,r){if(O){let s=new Worker(t,r),a=s;a.on("message",i=>{this.chan.emit({type:"worker-message",data:{uuid:e,data:i}})}),a.on("messageerror",i=>{this.chan.emit({type:"worker-messageerror",data:{uuid:e,data:i}})}),a.on("error",()=>{this.chan.emit({type:"worker-error",data:{uuid:e}})}),this.#e.set(e,s)}else be(t,s=>{s.addEventListener("message",a=>{this.chan.emit({type:"worker-message",data:{uuid:e,data:a.data}})}),s.addEventListener("messageerror",a=>{this.chan.emit({type:"worker-messageerror",data:{uuid:e,data:a.data}})}),s.addEventListener("error",()=>{this.chan.emit({type:"worker-error",data:{uuid:e}})}),this.#e.set(e,s)},s=>{throw s},r,!1)}postMessage(e){let{uuid:t,async:r,handles:s,data:a,transfer:i}=e.data,n=this.#e.get(t);if(!n)throw new Error(`Worker with uuid ${t} not found`);if(!r&&s){let o=u=>{let p=u.data.uuid,f=u.data.result,w=u.data.error;p===t&&(w?s.reject(new Error(w)):s.resolve(f),n.removeEventListener("message",o))};n.addEventListener("message",o)}n.postMessage({uuid:t,data:a},{transfer:i})}terminate(e){this.#e.get(e)?.terminate(),this.#e.delete(e)}};O&&(globalThis.Worker=Oe().Worker);var He=class extends Je{constructor(e){super(),this.close=()=>{},this.#r=async(r,s)=>{if(!(!s||!s.type))switch(s.type){case"resolve":this.#e=new Int32Array(s.data),this.resolve();return;case"response":this.resolveResponse(s);return;case"system":this.systemQueue.put(s.data);return;default:this.outputQueue.put(s);return;case"sync-request":{let a=s,i=a.data.msg,n=a.data.reqData;switch(i.type){case"read":{let o=await this.inputQueue.get();await X(r,n,o);break}case"event":{let o=this.eventQueue.shift();await X(r,n,o);break}case"eval-await":{let o=i.data,u={};try{u.result=await(0,eval)(o),typeof u.result=="function"&&(u.result=String(u.result))}catch(p){let f=p;u.error=f.message}await X(r,n,{type:"eval-response",data:u});break}case"post-message-worker":{let o=i.data;o.handles=ae(),this.systemQueue.put({type:"postMessageWorker",data:o}),o.async?await X(r,n,{type:"post-message-response"}):o.handles.promise.then(u=>{X(r,n,{type:"post-message-response",data:{result:u}})},u=>{X(r,n,{type:"post-message-response",data:{error:String(u)}})});break}default:throw new N(`Unsupported request type '${i.type}'.`)}return}case"request":throw new N("Can't send messages of type 'request' from a worker. Please Use 'sync-request' instead.")}},{resolve:this.resolve,reject:this.reject,promise:this.initialised}=ae();let t=r=>{this.#t(r),this.close=()=>{r.terminate(),this.putClosedMessage()};let s={type:"init",data:{config:e,channelType:V.SharedArrayBuffer}};r.postMessage(s)};if(Ve(e.baseUrl))be(`${e.baseUrl}webr-worker.js`,r=>t(r),r=>{this.reject(new P(`Worker loading error: ${r.message}`))});else{let r=new Worker(`${e.baseUrl}webr-worker.js`);t(r)}}#e;emit(e){if(!this.#e)throw new N("Failed attempt to interrupt before initialising interruptBuffer");this.eventQueue.push({type:"event",data:{msg:e}}),this.#e[0]=1}interrupt(){this.inputQueue.reset(),this.emit({type:"interrupt"})}#t(e){O?(e.on("message",t=>{this.#r(e,t)}),e.on("error",t=>{let r=t instanceof Error?t.message:String(t);console.error(r),this.reject(new P(`An error occurred initialising the webR SharedBufferChannel worker: ${r}.`))})):(e.onmessage=t=>this.#r(e,t.data),e.onerror=t=>{let r=t instanceof Error?t.message:String(t);console.error(r),this.reject(new P(`An error occurred initialising the webR SharedBufferChannel worker: ${r}.`))})}#r};O&&(globalThis.Worker=Oe().Worker);var Xe=class extends Je{constructor(e){super(),this.close=()=>{},this.emit=()=>{},this.#r=async(r,s)=>{if(!(!s||!s.type))switch(s.type){case"resolve":this.resolve();return;case"response":this.resolveResponse(s);return;case"system":this.systemQueue.put(s.data);return;default:this.outputQueue.put(s);return;case"request":{let a=s,i=a.data.msg;switch(i.type){case"read":{let n=await this.inputQueue.get();if(this.#e){let o=Vt(a.data.uuid,n);this.#e.postMessage(o)}break}default:throw new N(`Unsupported request type '${i.type}'.`)}return}case"sync-request":throw new N("Can't send messages of type 'sync-request' in PostMessage mode. Use 'request' instead.")}},{resolve:this.resolve,reject:this.reject,promise:this.initialised}=ae();let t=r=>{this.#e=r,this.#t(r),this.close=()=>{r.terminate(),this.putClosedMessage()};let s={type:"init",data:{config:e,channelType:V.PostMessage}};r.postMessage(s)};if(Ve(e.baseUrl))be(`${e.baseUrl}webr-worker.js`,r=>t(r),r=>{this.reject(new P(`Worker loading error: ${r.message}`))});else{let r=new Worker(`${e.baseUrl}webr-worker.js`);t(r)}}#e;interrupt(){console.error("Interrupting R execution is not available when using the PostMessage channel")}#t(e){O?(e.on("message",t=>{this.#r(e,t)}),e.on("error",t=>{console.error(t),this.reject(new P("An error occurred initialising the webR PostMessageChannel worker."))})):(e.onmessage=t=>this.#r(e,t.data),e.onerror=t=>{console.error(t),this.reject(new P("An error occurred initialising the webR PostMessageChannel worker."))})}#r},V={Automatic:0,SharedArrayBuffer:1,PostMessage:3};function Ht(e){switch(e.channelType){case V.SharedArrayBuffer:return new He(e);case V.PostMessage:return new Xe(e);case V.Automatic:default:return typeof SharedArrayBuffer<"u"?new He(e):new Xe(e)}}var Xt=O?__dirname+"/":"https://webr.r-wasm.org/v0.5.8/",Kt="https://repo.r-wasm.org",Ke="0.5.8",Qe="4.5.1";function R(e){return!!e&&(typeof e=="object"||typeof e=="function")&&"payloadType"in e&&qe(e._payload)}function Qt(e){return R(e)&&e._payload.obj.type==="null"}function Gt(e){return R(e)&&e._payload.obj.type==="symbol"}function Yt(e){return R(e)&&e._payload.obj.type==="pairlist"}function Zt(e){return R(e)&&e._payload.obj.type==="environment"}function er(e){return R(e)&&e._payload.obj.type==="logical"}function tr(e){return R(e)&&e._payload.obj.type==="integer"}function rr(e){return R(e)&&e._payload.obj.type==="double"}function sr(e){return R(e)&&e._payload.obj.type==="complex"}function nr(e){return R(e)&&e._payload.obj.type==="character"}function ir(e){return R(e)&&e._payload.obj.type==="list"}function ar(e){return R(e)&&e._payload.obj.type==="raw"}function or(e){return R(e)&&e._payload.obj.type==="call"}function Ge(e){return!!(R(e)&&e._payload.obj.methods?.includes("exec"))}function lr(){}function ur(e,t){return async function*(){let r={type:"callRObjectMethod",data:{payload:t._payload,prop:"getPropertyValue",args:[{payloadType:"raw",obj:"length"}],shelter:void 0}},s=await e.request(r);if(typeof s.obj!="number")throw new B("Cannot iterate over object, unexpected type for length property.");for(let a=1;a<=s.obj;a++)yield t.get(a)}}function Ye(e,t,r){return async(...s)=>{let a=s.map(o=>R(o)?o._payload:{obj:M(o,R,u=>u._payload),payloadType:"raw"}),i={type:"callRObjectMethod",data:{payload:r,prop:t,args:a}},n=await e.request(i);switch(n.payloadType){case"ptr":return $(e,n);case"raw":return M(n,qe,(o,u)=>$(u,o),e).obj}}}async function hr(e,t,r,...s){let a={type:"newRObject",data:{objType:t,args:M(s,R,n=>n._payload),shelter:r}},i=await e.request(a);switch(i.payloadType){case"raw":throw new G("Unexpected raw payload type returned from newRObject");case"ptr":return $(e,i)}}function $(e,t){let r=new Proxy(t.obj.methods?.includes("exec")?Object.assign(lr,{...t}):t,{get:(s,a)=>{if(a==="_payload")return t;if(a===Symbol.asyncIterator)return ur(e,r);if(t.obj.methods?.includes(a.toString()))return Ye(e,a.toString(),t)},apply:async(s,a,i)=>{let n=await $(e,t).exec(...i);return Ge(n)?n:n.toJs()}});return r}function D(e,t,r){return new Proxy(g,{construct:(s,a)=>hr(e,r,t,...a),get:(s,a)=>Ye(e,a.toString())})}var cr=class{#e;#t;#r;#s;#n;constructor(e={},t={REnv:{R_HOME:"/usr/lib/R",FONTCONFIG_PATH:"/etc/fonts",R_ENABLE_JIT:"0"}}){this.webR=new et(t),O||(this.canvas=document.createElement("canvas"),this.canvas.setAttribute("width","1008"),this.canvas.setAttribute("height","1008")),this.#e=e.stdout||this.#i,this.#t=e.stderr||this.#a,this.#r=e.prompt||this.#o,this.#s=e.canvasImage||this.#l,this.#n=e.canvasNewPage||this.#u,this.webR.evalRVoid("options(device=webr::canvas)")}stdin(e){this.webR.writeConsole(e)}interrupt(){this.webR.interrupt()}#i=e=>{console.log(e)};#a=e=>{console.error(e)};#o=e=>{let t=prompt(e);t&&this.stdin(`${t}
`)};#l=e=>{if(O)throw new Error("Plotting with HTML canvas is not yet supported under Node");this.canvas.getContext("2d").drawImage(e,0,0)};#u=()=>{if(O)throw new Error("Plotting with HTML canvas is not yet supported under Node");this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height)};run(){this.#h()}async#h(){for(;;){let e=await this.webR.read();switch(e.type){case"stdout":this.#e(e.data);break;case"stderr":this.#t(e.data);break;case"prompt":this.#r(e.data);break;case"canvas":e.data.event==="canvasImage"?this.#s(e.data.image):e.data.event==="canvasNewPage"&&this.#n();break;case"closed":return;default:console.warn(`Unhandled output type for webR Console: ${e.type}.`)}}}},dr={FONTCONFIG_PATH:"/etc/fonts",R_HOME:"/usr/lib/R",R_ENABLE_JIT:"0",ALL_PROXY:"socks5h://localhost:8580",WEBR:"1",WEBR_VERSION:Ke,R_VERSION:Qe},Ze={RArgs:[],REnv:dr,baseUrl:Xt,serviceWorkerUrl:"",repoUrl:Kt,homedir:"/home/web_user",interactive:!0,channelType:V.Automatic,createLazyFilesystem:!0},et=class{constructor(e={}){this.version=Ke,this.versionR=Qe,this.FS={analyzePath:async(r,s)=>{let a={type:"analyzePath",data:{path:r,dontResolveLastLink:s}};return(await this.#e.request(a)).obj},lookupPath:async r=>{let s={type:"lookupPath",data:{path:r}};return(await this.#e.request(s)).obj},mkdir:async r=>{let s={type:"mkdir",data:{path:r}};return(await this.#e.request(s)).obj},mount:async(r,s,a)=>{let i=[];"blobs"in s&&s.blobs&&(i=[...i,...s.blobs.map(o=>o.data instanceof Blob?o.data.arrayBuffer().then(u=>{o.data=new Uint8Array(u)}):Promise.resolve())]),"packages"in s&&s.packages&&(i=[...i,...s.packages.map(o=>o.blob instanceof Blob?o.blob.arrayBuffer().then(u=>{o.blob=new Uint8Array(u)}):Promise.resolve())]),await Promise.all(i);let n={type:"mount",data:{type:r,options:s,mountpoint:a}};await this.#e.request(n)},syncfs:async r=>{let s={type:"syncfs",data:{populate:r}};await this.#e.request(s)},readFile:async(r,s)=>{let a={type:"readFile",data:{path:r,flags:s}};return(await this.#e.request(a)).obj},rename:async(r,s)=>{let a={type:"rename",data:{oldpath:r,newpath:s}};await this.#e.request(a)},rmdir:async r=>{let s={type:"rmdir",data:{path:r}};await this.#e.request(s)},writeFile:async(r,s,a)=>{let i={type:"writeFile",data:{path:r,data:s,flags:a}};await this.#e.request(i)},unlink:async r=>{let s={type:"unlink",data:{path:r}};await this.#e.request(s)},unmount:async r=>{let s={type:"unmount",data:{path:r}};await this.#e.request(s)}};let t={...Ze,...e,REnv:{...Ze.REnv,...e.REnv}};this.#e=Ht(t),this.#t=new qt(this.#e),this.#r=new Jt(this.#e),this.objs={},this.Shelter=pr(this.#e),this.#s=this.#e.initialised.then(async()=>{this.globalShelter=await new this.Shelter,this.RObject=this.globalShelter.RObject,this.RLogical=this.globalShelter.RLogical,this.RInteger=this.globalShelter.RInteger,this.RDouble=this.globalShelter.RDouble,this.RComplex=this.globalShelter.RComplex,this.RCharacter=this.globalShelter.RCharacter,this.RRaw=this.globalShelter.RRaw,this.RList=this.globalShelter.RList,this.RDataFrame=this.globalShelter.RDataFrame,this.RPairlist=this.globalShelter.RPairlist,this.REnvironment=this.globalShelter.REnvironment,this.RSymbol=this.globalShelter.RSymbol,this.RString=this.globalShelter.RString,this.RCall=this.globalShelter.RCall,this.objs={baseEnv:await this.RObject.getPersistentObject("baseEnv"),globalEnv:await this.RObject.getPersistentObject("globalEnv"),null:await this.RObject.getPersistentObject("null"),true:await this.RObject.getPersistentObject("true"),false:await this.RObject.getPersistentObject("false"),na:await this.RObject.getPersistentObject("na")},this.#n()})}#e;#t;#r;#s;async init(){return this.#s}async#n(){for(;;){let e=await this.#e.readSystem();switch(e.type){case"setTimeoutWasm":setTimeout((t,r)=>{this.invokeWasmFunction(t,...r)},e.data.delay,e.data.ptr,e.data.args);break;case"proxyWebSocket":{let t=e;this.#t.new(t.data.uuid,t.data.url,t.data.protocol);break}case"sendWebSocket":{let t=e;this.#t.send(t.data.uuid,t.data.data);break}case"closeWebSocket":{let t=e;this.#t.close(t.data.uuid,t.data.code,t.data.reason);break}case"proxyWorker":{let t=e;this.#r.new(t.data.uuid,t.data.url,t.data.options);break}case"postMessageWorker":{let t=e;this.#r.postMessage(t);break}case"terminateWorker":{let t=e;this.#r.terminate(t.data.uuid);break}case"console.log":console.log(e.data);break;case"console.warn":console.warn(e.data);break;case"console.error":console.error(e.data);break;case"close":this.#e.close();break;default:throw new B("Unknown system message type `"+e.type+"`")}}}close(){this.#e.close()}async read(){return await this.#e.read()}async*stream(){for(;;){let e=await this.#e.read();if(e.type==="closed")return;yield e}}async flush(){return await this.#e.flush()}write(e){this.#e.write(e)}writeConsole(e){this.write({type:"stdin",data:e+`
`})}interrupt(){this.#e.interrupt()}async installPackages(e,t){let r=Object.assign({quiet:!1,mount:!0},t),s={type:"installPackages",data:{name:e,options:r}};await this.#e.request(s)}async destroy(e){await this.globalShelter.destroy(e)}async evalR(e,t){return this.globalShelter.evalR(e,t)}async evalRVoid(e,t){return this.evalRRaw(e,"void",t)}async evalRBoolean(e,t){return this.evalRRaw(e,"boolean",t)}async evalRNumber(e,t){return this.evalRRaw(e,"number",t)}async evalRString(e,t){return this.evalRRaw(e,"string",t)}async evalRRaw(e,t,r={}){let s=M(r,R,n=>n._payload),a={type:"evalRRaw",data:{code:e,options:s,outputType:t}},i=await this.#e.request(a);switch(i.payloadType){case"raw":return i.obj;case"ptr":throw new G("Unexpected ptr payload type returned from evalRVoid")}}async invokeWasmFunction(e,...t){let r={type:"invokeWasmFunction",data:{ptr:e,args:t}};return(await this.#e.request(r)).obj}},Ee=class{#e="";#t;#r=!1;constructor(e){this.#t=e}async init(){if(this.#r)return;let e={type:"newShelter"},t=await this.#t.request(e);this.#e=t.obj,this.RObject=D(this.#t,this.#e,"object"),this.RLogical=D(this.#t,this.#e,"logical"),this.RInteger=D(this.#t,this.#e,"integer"),this.RDouble=D(this.#t,this.#e,"double"),this.RComplex=D(this.#t,this.#e,"complex"),this.RCharacter=D(this.#t,this.#e,"character"),this.RRaw=D(this.#t,this.#e,"raw"),this.RList=D(this.#t,this.#e,"list"),this.RDataFrame=D(this.#t,this.#e,"dataframe"),this.RPairlist=D(this.#t,this.#e,"pairlist"),this.REnvironment=D(this.#t,this.#e,"environment"),this.RSymbol=D(this.#t,this.#e,"symbol"),this.RString=D(this.#t,this.#e,"string"),this.RCall=D(this.#t,this.#e,"call"),this.#r=!0}async purge(){let e={type:"shelterPurge",data:this.#e};await this.#t.request(e)}async destroy(e){let t={type:"shelterDestroy",data:{id:this.#e,obj:e._payload}};await this.#t.request(t)}async size(){let e={type:"shelterSize",data:this.#e};return(await this.#t.request(e)).obj}async evalR(e,t={}){let r=M(t,R,i=>i._payload),s={type:"evalR",data:{code:e,options:r,shelter:this.#e}},a=await this.#t.request(s);switch(a.payloadType){case"raw":throw new G("Unexpected payload type returned from evalR");default:return $(this.#t,a)}}async captureR(e,t={}){let r=M(t,R,i=>i._payload),s={type:"captureR",data:{code:e,options:r,shelter:this.#e}},a=await this.#t.request(s);switch(a.payloadType){case"ptr":throw new G("Unexpected payload type returned from evalR");case"raw":{let i=a.obj,n=$(this.#t,i.result),o=i.output,u=i.images;for(let p=0;p<o.length;++p)o[p].type!=="stdout"&&o[p].type!=="stderr"&&(o[p].data=$(this.#t,o[p].data));return{result:n,output:o,images:u}}}}};function pr(e){return new Proxy(Ee,{construct:async()=>{let t=new Ee(e);return await t.init(),t}})}export{V as ChannelType,cr as Console,Ee as Shelter,et as WebR,N as WebRChannelError,B as WebRError,G as WebRPayloadError,P as WebRWorkerError,or as isRCall,nr as isRCharacter,sr as isRComplex,rr as isRDouble,Zt as isREnvironment,Ge as isRFunction,tr as isRInteger,ir as isRList,er as isRLogical,Qt as isRNull,R as isRObject,Yt as isRPairlist,ar as isRRaw,Gt as isRSymbol,Dt as isShelterID};
